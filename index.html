<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Taxi Pro ‚Äî –¢–∞–∫—Å–∏ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</title>
<link rel="manifest" href="manifest.json">

<style>
  :root {
    --bg: #111111;
    --panel: #1c1c1e;
    --panel2: #262628;
    --text: #ffffff;
    --muted: #a9a9ad;
    --accent: #FFD54F;
    --accent2: #FFEC9A;
    --ok: #78e08f;
    --warn: #ffd369;
    --bad: #ff7675;
    --radius: 16px;
    --shadow: 0 12px 28px rgba(0, 0, 0, .35);
    --app-height: 100vh; /* —Ñ–∏–∫—Å –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º–∞ */
  }

  * { box-sizing: border-box }

  html, body {
    margin: 0;
    padding: 0;
    height: var(--app-height);
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    overflow: hidden; /* —á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª—Å—è –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
  }

  .app {
    height: 100%;
    display: flex;
    flex-direction: column;
    max-width: 520px;
    margin: 0 auto;
  }

  .content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 12px 12px 90px;
  }

  /* ======== –®–∞–ø–∫–∞ ======== */
  .appbar {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(180deg, rgba(17, 17, 17, .95), rgba(17, 17, 17, .7));
    backdrop-filter: blur(6px);
    border-bottom: 1px solid rgba(255, 255, 255, .06);
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--accent), #ffa000);
    box-shadow: var(--shadow);
  }

  .title {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .title b { font-size: 15px }
  .title span { font-size: 12px; color: var(--muted) }

  .appbar .right {
    margin-left: auto;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .car-chip {
    background: var(--panel);
    border: 1px solid rgba(255, 255, 255, .08);
    color: var(--text);
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 10px;
    cursor: pointer;
  }

  /* ======== –ù–∞–≤–∏–≥–∞—Ü–∏—è ======== */
  .nav {
    position: sticky;
    bottom: 0;
    background: linear-gradient(0deg, rgba(17, 17, 17, 1), rgba(17, 17, 17, .85));
    backdrop-filter: blur(6px);
    border-top: 1px solid rgba(255, 255, 255, .06);
    display: flex;
    gap: 6px;
    padding: 8px;
    z-index: 50;
  }

  .navbtn {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-radius: 12px;
    color: var(--muted);
    cursor: pointer;
    font-weight: 500;
  }

  .navbtn.active {
    background: var(--panel);
    border: 1px solid rgba(255, 255, 255, .06);
    color: var(--text);
  }

  /* ======== –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ======== */
  .tabs { display:flex; background:var(--panel); border:1px solid rgba(255,255,255,.06);
    border-radius:12px; overflow:hidden; margin-bottom:8px }
  .tab { padding:8px 10px; color:var(--muted); cursor:pointer; user-select:none; font-size:13px; }
  .tab.active { background:linear-gradient(180deg,var(--accent2),var(--accent)); color:#141414; font-weight:800 }
  input[type="date"] {
    background: var(--panel);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, .08);
    border-radius: 10px;
    padding: 8px;
    font-size: 12px;
  }

  .stats { text-align:center; margin:8px 0 10px }
  .stats h1 { margin:6px 0 0; font-size:38px }
  .stats p { margin:0; color:var(--muted) }

  .cards { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 }
  .card {
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: .2s;
  }

  .card:hover { background: var(--panel2) }
  .card h3 { margin: 0; font-size: 18px }
  .card p { margin: 6px 0 0; font-size: 12px; color: var(--muted) }
  .card.readonly { cursor: default }

  .chart { display:flex; align-items:flex-end; gap:12px; overflow-x:auto; padding-bottom:8px; margin-top:8px }
  .barcol { display:flex; flex-direction:column; align-items:center; min-width:44px }
  .bar-top { font-size:11px; color:#ddd; margin-bottom:6px }
  .bar {
    width:26px;
    background: linear-gradient(180deg, var(--accent2), var(--accent));
    border-radius:8px;
    transition:height .35s ease;
  }
  .bar-bottom { font-size:11px; color:var(--muted); margin-top:6px }

  .section { margin-top:12px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px }
  .list { display:grid; gap:8px; margin-top:8px }
  .row {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px; border-radius:12px; background:var(--panel);
    border:1px solid rgba(255,255,255,.06);
  }

  .pill { padding:4px 8px; border-radius:999px; font-size:11px; font-weight:700 }
  .pill.ok { background:#112d1c; color:#8ff0b0; border:1px solid #236a3a }
  .pill.warn { background:#332a11; color:#ffd37a; border:1px solid #6a551d }
  .pill.bad { background:#331616; color:#ff8d8d; border:1px solid #6a1d1d }

  .hidden { display:none }
</style>
</head>
<body>
<div class="app">
  <div class="appbar">
    <div class="logo"></div>
    <div class="title">
      <b>Taxi Pro</b>
      <span id="subtitle">–ì–ª–∞–≤–Ω–∞—è ¬∑ —Å–µ–≥–æ–¥–Ω—è</span>
    </div>
    <div class="right">
      <div id="activeCarChip" class="car-chip">–ê–≤—Ç–æ: ‚Äî</div>
    </div>
  </div>

  <div class="content" id="content">
    <!-- —Å—é–¥–∞ –ø–æ–π–¥—ë—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–≥—Ä–∞—Ñ–∏–∫–∏, –∫–∞—Ä—Ç–æ—á–∫–∏, –æ—Ç—á—ë—Ç—ã) -->
  </div>

  <div class="nav">
    <div class="navbtn active" data-screen="home">üè† –ì–ª–∞–≤–Ω–∞—è</div>
    <div class="navbtn" data-screen="reports">üìä –û—Ç—á—ë—Ç—ã</div>
    <div class="navbtn" data-screen="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
</div>
<script>
/* ========= –£—Ç–∏–ª–∏—Ç—ã ========= */
const fmt = (n) => (Math.round(n)).toLocaleString('ru-RU');
const rub = (n) => `${fmt(n)} ‚ÇΩ`;
const todayISO = () => { const d=new Date();return d.toISOString().slice(0,10); };
const addDays = (iso,delta)=>{const d=new Date(iso);d.setDate(d.getDate()+delta);return d.toISOString().slice(0,10);}
const rangeDays=(end,count)=>{const a=[];for(let i=count-1;i>=0;i--)a.push(addDays(end,-i));return a;}
const isoToShort = (iso)=>{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});}

/* ========= Storage ========= */
const LS_KEY = 'taxiAnalyzerV13';
function loadAll() {
  const raw = localStorage.getItem(LS_KEY);
  if (raw) return JSON.parse(raw);

  // === –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ ===
  const carId = crypto.randomUUID();
  const seedData = {};
  for (let i = 1; i <= 10; i++) {
    const d = `2025-11-${String(i).padStart(2, '0')}`;
    seedData[d] = {
      orders: 15 + (i % 5),
      income: 5800 + (i % 3) * 400,
      rent: 2790,
      fuel: 1300 + (i % 2) * 100,
      tips: 150 + (i % 2) * 50,
      otherIncome: (i % 5 === 0) ? 400 : 0,
      otherExpense: (i % 4 === 0) ? 200 : 0,
      fines: 0,
      hours: 8 + (i % 3)
    };
  }

  const obj = {
    activeCarId: carId,
    cars: [{ id: carId, name: 'Kia Rio', cls: '–ö–æ–º—Ñ–æ—Ä—Ç', tank: 50 }],
    settings: { parkMode: '150day', taxMode: 'none' },
    dataByCar: { [carId]: seedData }
  };
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
  return obj;
}
function saveAll() { localStorage.setItem(LS_KEY, JSON.stringify(APP)); }

/* ========= State ========= */
let APP = loadAll();
let currentScreen='home';
let currentPeriod='day';
let currentDate=todayISO();

const byCar = () => APP.dataByCar[APP.activeCarId] || (APP.dataByCar[APP.activeCarId]={});
const ensureDay = (iso) => {
  const d = byCar()[iso];
  if (d) return d;
  return (byCar()[iso] = {orders:0,income:0,rent:0,fuel:0,tips:0,otherIncome:0,otherExpense:0,fines:0,hours:0});
}

/* ========= DOM ========= */
const subtitle=document.getElementById('subtitle');
const activeCarChip=document.getElementById('activeCarChip');
const content=document.getElementById('content');
const navbtns=document.querySelectorAll('.navbtn');

/* ========= –†–∞—Å—á—ë—Ç—ã ========= */
function calcCommission(d){
  const mode=APP.settings.parkMode||'none';
  if(mode==='none')return 0;
  if(mode==='150day')return((d.income||0)>0||(d.orders||0)>0)?150:0;
  if(mode==='15order')return(d.orders||0)*15;
  if(mode==='20order')return(d.orders||0)*20;
  if(mode==='4pct')return(d.income||0)*0.04;
  return 0;
}
function calcTax(d){
  const mode=APP.settings.taxMode||'none';
  if(mode==='self4')return(d.income||0)*0.04;
  if(mode==='ip6')return(d.income||0)*0.06;
  return 0;
}
function calcDay(iso){
  const d=ensureDay(iso);
  const gross=(d.income||0)+(d.tips||0)+(d.otherIncome||0);
  const commission=calcCommission(d);
  const tax=calcTax(d);
  const costs=(d.rent||0)+(d.fuel||0)+(d.otherExpense||0)+(d.fines||0)+commission+tax;
  const profit=gross-costs;
  const eff=gross>0?Math.max(0,Math.round((profit/gross)*100)):0;
  const perHour=(d.hours||0)>0?profit/d.hours:0;
  return {...d,commission,tax,gross,costs,profit,eff,perHour};
}
function sumRange(arr){
  return arr.reduce((acc,iso)=>{
    const d=ensureDay(iso);
    const c=calcCommission(d);
    const t=calcTax(d);
    acc.orders+=Number(d.orders||0);
    acc.income+=Number(d.income||0);
    acc.rent+=Number(d.rent||0);
    acc.fuel+=Number(d.fuel||0);
    acc.tips+=Number(d.tips||0);
    acc.otherIncome+=Number(d.otherIncome||0);
    acc.otherExpense+=Number(d.otherExpense||0);
    acc.fines+=Number(d.fines||0);
    acc.hours+=Number(d.hours||0);
    acc.commission+=c;
    acc.tax+=t;
    return acc;
  },{orders:0,income:0,rent:0,fuel:0,tips:0,otherIncome:0,otherExpense:0,fines:0,hours:0,commission:0,tax:0});
}

/* ========= –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ ========= */
function renderTimeline(values, labels, dates){
  const wrap=document.createElement('div');
  wrap.className='chart';
  const max=Math.max(1,...values.map(v=>Math.max(0,v)));
  values.forEach((v,i)=>{
    const col=document.createElement('div');
    col.className='barcol';
    const top=document.createElement('div');
    top.className='bar-top';
    top.textContent=v>0?rub(v):'0 ‚ÇΩ';
    const bar=document.createElement('div');
    bar.className='bar';
    bar.style.height=`${(Math.max(0,v)/max)*160}px`;
    bar.onclick=()=>{
      currentDate=dates[i];
      renderHome();
    };
    const bottom=document.createElement('div');
    bottom.className='bar-bottom';
    bottom.textContent=labels[i];
    col.appendChild(top);
    col.appendChild(bar);
    col.appendChild(bottom);
    wrap.appendChild(col);
  });
  return wrap;
}

/* ========= –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ========= */
function renderHome(){
  content.innerHTML='';
  const d=new Date(currentDate);
  subtitle.textContent=`–ì–ª–∞–≤–Ω–∞—è ¬∑ ${d.toLocaleDateString('ru-RU')}`;

  const x=calcDay(currentDate);
  const stats=document.createElement('div');
  stats.className='stats';
  stats.innerHTML=`<h1>${rub(x.gross)}</h1><p>${fmt(x.orders)} –∑–∞–∫–∞–∑–æ–≤</p>`;

  const chartDays=[];
  for(let i=-3;i<=3;i++) chartDays.push(addDays(currentDate,i));
  const vals=chartDays.map(iso=>calcDay(iso).profit);
  const labels=chartDays.map(iso=>isoToShort(iso));
  const chart=renderTimeline(vals,labels,chartDays);

  content.appendChild(stats);
  content.appendChild(chart);
}

/* ========= –ù–∞–≤–∏–≥–∞—Ü–∏—è ========= */
navbtns.forEach(n=>{
  n.addEventListener('click',()=>{
    navbtns.forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    currentScreen=n.dataset.screen;
    if(currentScreen==='home')renderHome();
    if(currentScreen==='reports')renderReports();
    if(currentScreen==='settings')renderSettings();
  });
});

/* ========= –û—Ç—á—ë—Ç—ã ========= */
function renderReports(){
  content.innerHTML='';
  subtitle.textContent='üìä –û—Ç—á—ë—Ç—ã';
  const arr=rangeDays(todayISO(),7);
  const s=sumRange(arr);
  const gross=s.income+s.tips+s.otherIncome;
  const profit=gross-(s.rent+s.fuel+s.otherExpense+s.fines+s.commission+s.tax);
  const eff=gross>0?Math.round((profit/gross)*100):0;
  const perHour=(s.hours||0)>0?profit/s.hours:0;
  content.innerHTML=`
  <div class="stats"><h1>${rub(gross)}</h1><p>–∑–∞ –Ω–µ–¥–µ–ª—é</p></div>
  <div class="list">
    <div class="row"><div>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div><b>${rub(profit)}</b></div>
    <div class="row"><div>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><b>${eff}%</b></div>
    <div class="row"><div>‚ÇΩ/—á–∞—Å</div><b>${fmt(Math.round(perHour))}</b></div>
  </div>`;
}

/* ========= –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ========= */
function renderSettings(){
  content.innerHTML='';
  subtitle.textContent='‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
  const wrap=document.createElement('div');
  wrap.innerHTML=`
    <div class="row"><div>–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</div><button id="resetBtn" class="car-chip">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
  `;
  content.appendChild(wrap);
  document.getElementById('resetBtn').onclick=()=>{
    if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')){
      localStorage.removeItem(LS_KEY);
      APP=loadAll();
      renderHome();
    }
  };
}

/* ========= Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ========= */
(function initTelegram(){
  try{
    if(window.Telegram&&Telegram.WebApp){
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      Telegram.WebApp.setHeaderColor("secondary_bg_color");
      if(Telegram.WebApp.disableVerticalSwipes){
        Telegram.WebApp.disableVerticalSwipes();
      }
      console.log("[TaxiPro] Telegram WebApp initialized ‚úÖ");
    }else console.warn("[TaxiPro] Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚ö†Ô∏è");
  }catch(e){console.error("[TaxiPro] Telegram init error:",e);}
})();

/* ========= –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ ========= */
function setAppHeight(){
  document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
}
window.addEventListener('resize', setAppHeight);
window.addEventListener('orientationchange', setAppHeight);
setAppHeight();

/* ========= –ó–∞–ø—É—Å–∫ ========= */
renderHome();
</script>
<!-- ======= MODALS ======= -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <header><b id="modalTitle">–ò–∑–º–µ–Ω–∏—Ç—å</b></header>
    <div class="body">
      <label id="modalLabel">–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
      <input id="modalInput" type="number" step="1" min="0" placeholder="0">
      <div id="quickArea" class="quick"></div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<style>
/* ======= Modal style ======= */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 12px;
  opacity: 0;
  pointer-events: none;
  transition: .25s;
  z-index: 999;
}
.modal-bg.show { opacity: 1; pointer-events: auto; }
.modal {
  width: 100%;
  max-width: 520px;
  background: var(--panel);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 16px 16px 12px 12px;
  box-shadow: var(--shadow);
  transform: translateY(30px);
  transition: .25s;
}
.modal-bg.show .modal { transform: translateY(0); }
.modal header { padding: 12px 12px 6px; border-bottom: 1px solid rgba(255,255,255,.06); }
.modal header b { font-size: 14px; }
.modal .body { padding: 12px; display: grid; gap: 8px; }
.modal .body label { font-size: 12px; color: var(--muted); }
.modal .body input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.08);
  background: #0f0f10;
  color: var(--text);
  font-size: 16px;
}
.quick { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
.chip {
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--panel2);
  border: 1px solid rgba(255,255,255,.08);
  cursor: pointer;
}
.chip:hover { background: var(--panel); }
.modal .actions { display: flex; gap: 8px; padding: 10px; }
.btn {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 800;
}
.btn.primary { background: linear-gradient(180deg, var(--accent2), var(--accent)); color: #1a1a1a; }
.btn.ghost { background: var(--panel2); color: var(--text); border: 1px solid rgba(255,255,255,.06); }

/* Scroll fix –¥–ª—è Telegram */
body, html {
  overscroll-behavior: contain;
  touch-action: manipulation;
}
</style>

<script>
/* ========= –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ========= */
const modalBg = document.getElementById('modalBg');
const modalTitle=document.getElementById('modalTitle');
const modalLabel=document.getElementById('modalLabel');
const modalInput=document.getElementById('modalInput');
const quickArea=document.getElementById('quickArea');
const btnCancel=document.getElementById('btnCancel');
const btnSave=document.getElementById('btnSave');
let editField=null;

const QUICK_PRESETS = {
  income: [1000,3000,5000],
  otherIncome: [500,1000,2000],
  tips: [50,100,200],
  rent: [500,1000,1500],
  fuel: [100,500,1000],
  otherExpense: [100,300,500],
  fines: [500,1000,3000],
  orders: [1,5,10],
  hours: [1,2,4]
};

function renderQuick(field){
  quickArea.innerHTML='';
  (QUICK_PRESETS[field]||[]).forEach(val=>{
    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent=field==='orders'||field==='hours'?`+${val}`:`+${val} ‚ÇΩ`;
    chip.onclick=()=>{ modalInput.value = Number(modalInput.value||0) + val; };
    quickArea.appendChild(chip);
  });
}
function openModal(field,title){
  editField=field; modalTitle.textContent=title;
  modalInput.value=Number(ensureDay(currentDate)[field]||0);
  renderQuick(field);
  modalBg.classList.add('show');
  modalInput.focus();
}
function closeModal(){ modalBg.classList.remove('show'); editField=null; }
btnCancel.onclick=closeModal;
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) closeModal(); });
btnSave.onclick=()=>{
  if(!editField)return;
  const v=Number(modalInput.value||0);
  ensureDay(currentDate)[editField]=v;
  saveAll(); closeModal(); renderHome();
};

/* ========= –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ========= */
document.addEventListener('click',e=>{
  const el=e.target.closest('.card[data-edit]');
  if(!el)return;
  const field=el.dataset.edit;
  const titles={
    income:'–î–æ—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å',
    tips:'–ß–∞–µ–≤—ã–µ –∑–∞ –¥–µ–Ω—å',
    otherIncome:'–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã',
    orders:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
    rent:'–ê—Ä–µ–Ω–¥–∞',
    fuel:'–¢–æ–ø–ª–∏–≤–æ',
    otherExpense:'–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
    fines:'–®—Ç—Ä–∞—Ñ—ã',
    hours:'–ß–∞—Å—ã –∑–∞ –¥–µ–Ω—å'
  };
  openModal(field,titles[field]||'–ò–∑–º–µ–Ω–∏—Ç—å');
});

/* ========= Anti-scroll collapse fix (–≤–∞–∂–Ω–æ –¥–ª—è Telegram) ========= */
(function preventCollapse(){
  let startY=0;
  document.addEventListener('touchstart',e=>{
    startY=e.touches[0].clientY;
  },{passive:false});
  document.addEventListener('touchmove',e=>{
    const deltaY=e.touches[0].clientY-startY;
    if(window.scrollY===0&&deltaY>5){ e.preventDefault(); }
  },{passive:false});
})();
</script>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
/>
<title>–¢–∞–∫—Å–∏ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</title>
<link rel="manifest" href="manifest.json" />

<style>
  :root{
    --bg:#111111; --panel:#1c1c1e; --panel2:#262628; --text:#ffffff; --muted:#a9a9ad;
    --accent:#FFD54F; --accent2:#FFEC9A; --ok:#78e08f; --warn:#ffd369; --bad:#ff7675;
    --radius:16px; --shadow:0 12px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}

  /* –ë–∞–∑–æ–≤–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞: —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É —ç–∫—Ä–∞–Ω–∞, —É—á–∏—Ç—ã–≤–∞–µ–º safe-area */
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    min-height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤ .content */
    overflow: hidden;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –Ω–∞ –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –≤—ã—Å–æ—Ç—É, –≤–∫–ª—é—á–∞—è 100dvh/safe-area */
  .app{
    max-width: 520px;
    margin: 0 auto;
    min-height: 100dvh;          /* –∫–ª—é—á–µ–≤–æ–π —Ñ–∏–∫—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
    height: 100dvh;              /* —Å—Ç–∞—Ä–∞–µ–º—Å—è –∑–∞–Ω—è—Ç—å –≤—Å—é d-–≤—ã—Å–æ—Ç—É */
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    display:flex;
    flex-direction:column;
  }

  /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤–≤–µ—Ä—Ö—É, –≤–Ω—É—Ç—Ä–∏ –Ω–µ —Å–∫—Ä–æ–ª–ª—è—â–µ–≥–æ—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ */
  .appbar{
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(180deg,rgba(17,17,17,.95),rgba(17,17,17,.7));
    backdrop-filter: blur(6px);
    border-bottom: 1px solid rgba(255,255,255,.06);
    padding: 12px;
    display:flex; align-items:center; gap:10px
  }
  .logo{width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#ffa000);box-shadow:var(--shadow)}
  .title{display:flex;flex-direction:column;gap:2px}
  .title b{font-size:15px}
  .title span{font-size:12px;color:var(--muted)}
  .appbar .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .car-chip{background:var(--panel);border:1px solid rgba(255,255,255,.08);color:var(--text);font-size:12px;padding:6px 8px;border-radius:10px;cursor:pointer}

  /* –°–∫—Ä–æ–ª–ª–∏–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç. –°–Ω–∏–∑—É ‚Äî –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏—é + safe-area */
  .content{
    flex: 1 1 auto;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 12px 12px calc(90px + env(safe-area-inset-bottom));
  }

  .top-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .tabs{display:flex;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:12px;overflow:hidden;flex-shrink:0}
  .tab{padding:8px 12px;color:var(--muted);cursor:pointer;user-select:none;text-align:center;min-width:70px;transition:.15s}
  .tab.active{background:linear-gradient(180deg,var(--accent2),var(--accent));color:#141414;font-weight:800}
  input[type="date"]{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;font-size:12px}
  .stats{text-align:center;margin:8px 0 10px}
  .stats h1{margin:6px 0 0;font-size:40px}
  .stats p{margin:0;color:var(--muted)}
  .group-title{margin-top:8px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;text-align:center;box-shadow:var(--shadow);cursor:pointer;transition:.2s}
  .card:hover{background:var(--panel2)}
  .card h3{margin:0;font-size:19px}
  .card p{margin:6px 0 0;font-size:12px;color:var(--muted)}
  .card.readonly{cursor:default}

  /* –î–∏–∞–≥—Ä–∞–º–º–∞ */
  .chart-wrap{margin-top:6px;width:100%}
  .chart{
    display:flex;align-items:flex-end;justify-content:space-around;width:100%;
    gap:12px;overflow-x:auto;padding-bottom:8px;box-sizing:border-box
  }
  .barcol{flex:1;min-width:44px;display:flex;flex-direction:column;align-items:center}
  .bar-top{font-size:11px;color:#ddd;margin-bottom:6px}
  .bar{width:26px;background:linear-gradient(180deg,var(--accent2),var(--accent));border-radius:8px;transition:height .35s ease}
  .bar:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(255,213,79,.5)}
  .bar-bottom{font-size:11px;color:var(--muted);margin-top:6px}

  .section{margin-top:12px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
  .list{display:grid;gap:8px;margin-top:8px}
  .row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:var(--panel);border:1px solid rgba(255,255,255,.06)}
  .pill{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
  .pill.ok{background:#112d1c;color:#8ff0b0;border:1px solid #236a3a}
  .pill.warn{background:#332a11;color:#ffd37a;border:1px solid #6a551d}
  .pill.bad{background:#331616;color:#ff8d8d;border:1px solid #6a1d1d}
  .hidden{display:none}

  /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî –ü–†–ò–ö–õ–ï–ï–ù–ê –∫ –Ω–∏–∑—É, —É—á–∏—Ç—ã–≤–∞–µ—Ç safe-area */
  .nav{
    position: sticky;
    bottom: 0;
    z-index: 10;
    background: linear-gradient(0deg,rgba(17,17,17,1),rgba(17,17,17,.85));
    backdrop-filter: blur(6px);
    border-top:1px solid rgba(255,255,255,.06);
    display:flex; gap:6px; padding:8px;
    padding-bottom: calc(8px + env(safe-area-inset-bottom)); /* —á—Ç–æ–±—ã –Ω–µ —Å—ä–µ–¥–∞–ª–æ—Å—å –Ω–∞ iPhone */
  }
  .navbtn{flex:1;text-align:center;padding:10px;border-radius:12px;color:var(--muted);cursor:pointer}
  .navbtn.active{background:var(--panel);border:1px solid rgba(255,255,255,.06);color:var(--text)}
  .hint{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
  footer{margin:12px auto 0;color:var(--muted);font-size:12px;text-align:center}

  /* –ú–æ–¥–∞–ª–∫–∏ */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;padding:12px;opacity:0;pointer-events:none;transition:.25s;z-index:999}
  .modal-bg.show{opacity:1;pointer-events:auto}
  .modal{width:100%;max-width:520px;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px 16px 12px 12px;box-shadow:var(--shadow);transform:translateY(30px);transition:.25s}
  .modal-bg.show .modal{transform:translateY(0)}
  .modal header{padding:12px 12px 6px;border-bottom:1px solid rgba(255,255,255,.06)}
  .modal header b{font-size:14px}
  .modal .body{padding:12px;display:grid;gap:8px}
  .modal .body label{font-size:12px;color:var(--muted)}
  .modal .body input, .modal .body select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f0f10;color:var(--text);font-size:16px}
  .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--panel2);border:1px solid rgba(255,255,255,.08);cursor:pointer}
  .chip:hover{background:var(--panel)}
  .modal .actions{display:flex;gap:8px;padding:10px}
  .btn{flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(180deg,var(--accent2),var(--accent));color:#1a1a1a}
  .btn.ghost{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.06)}

  /* –û—Ç—á—ë—Ç—ã */
  .r-tabs{display:flex;gap:6px;margin-bottom:8px}
  .r-tab{flex:1;text-align:center;padding:8px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,.06);color:var(--muted);cursor:pointer;font-weight:600;transition:0.15s}
  .r-tab:hover{background:var(--panel2);color:var(--text)}
  .r-tab.active{color:var(--text);background:var(--panel2);border:1px solid rgba(255,255,255,.15)}

  .r-range{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  .r-range input{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 8px;font-size:12px}

  .collapse{border:1px solid rgba(255,255,255,.06);border-radius:12px;overflow:hidden}
  .collapse summary{list-style:none;padding:10px;background:var(--panel2);cursor:pointer}
  .collapse summary::-webkit-details-marker{display:none}
  .collapse .body{padding:8px;background:var(--panel)}

  /* –ñ–µ—Å—Ç—ã/—Å–∫—Ä–æ–ª–ª ‚Äî –∏–∑–±–µ–≥–∞–µ–º ¬´–æ—Ç—Å–∫–æ–∫–∞¬ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ Telegram/Safari */
  body, html { overscroll-behavior: none; touch-action: manipulation; }
</style>
</head>
<body>
<div class="app">
  <div class="appbar">
    <div class="logo"></div>
    <div class="title">
      <b>–¢–∞–∫—Å–∏ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</b>
      <span id="subtitle">–ì–ª–∞–≤–Ω–∞—è ¬∑ —Å–µ–≥–æ–¥–Ω—è</span>
    </div>
    <div class="right">
      <div id="activeCarChip" class="car-chip">–ê–≤—Ç–æ: ‚Äî</div>
    </div>
  </div>

  <div class="content">
    <!-- HOME -->
    <div id="screen-home">
      <div class="top-controls">
        <div class="tabs" id="tabs">
          <div class="tab active" data-period="day">–î–µ–Ω—å</div>
          <div class="tab" data-period="week">–ù–µ–¥–µ–ª—è</div>
          <div class="tab" data-period="month">–ú–µ—Å—è—Ü</div>
        </div>
        <input id="dateInput" type="date">
      </div>

      <div class="stats">
        <h1 id="sumTotal">0 ‚ÇΩ</h1>
        <p id="ordersLine">0 –∑–∞–∫–∞–∑–æ–≤</p>
      </div>

      <div class="group-title">üí∞ –î–æ—Ö–æ–¥—ã</div>
      <div class="cards">
        <div class="card" data-edit="income"><h3 id="cIncome">0 ‚ÇΩ</h3><p>–î–æ—Ö–æ–¥</p></div>
        <div class="card" data-edit="tips"><h3 id="cTips">0 ‚ÇΩ</h3><p>–ß–∞–µ–≤—ã–µ</p></div>
        <div class="card" data-edit="otherIncome"><h3 id="cOtherIncome">0 ‚ÇΩ</h3><p>–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã</p></div>
        <div class="card" data-edit="orders"><h3 id="cOrders">0</h3><p>–ó–∞–∫–∞–∑—ã</p></div>
      </div>

      <div class="group-title">üí∏ –†–∞—Å—Ö–æ–¥—ã</div>
      <div class="cards">
        <div class="card" data-edit="rent"><h3 id="cRent">0 ‚ÇΩ</h3><p>–ê—Ä–µ–Ω–¥–∞</p></div>
        <div class="card" data-edit="fuel"><h3 id="cFuel">0 ‚ÇΩ</h3><p>–¢–æ–ø–ª–∏–≤–æ</p></div>
        <div class="card" data-edit="otherExpense"><h3 id="cOtherExpense">0 ‚ÇΩ</h3><p>–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p></div>
        <div class="card" data-edit="fines"><h3 id="cFines">0 ‚ÇΩ</h3><p>–®—Ç—Ä–∞—Ñ—ã</p></div>
      </div>

      <div class="group-title">‚è± –í—Ä–µ–º—è</div>
      <div class="cards">
        <div class="card" data-edit="hours"><h3 id="cHours">0 —á</h3><p>–ß–∞—Å—ã –∑–∞ —Å–º–µ–Ω—É</p></div>
        <div class="card readonly"><h3 id="cPerHour">0 ‚ÇΩ/—á</h3><p>–ó–∞—Ä–∞–±–æ—Ç–æ–∫ –≤ —á–∞—Å</p></div>
      </div>

      <div class="group-title">üìä –ò—Ç–æ–≥–æ</div>
      <div class="cards">
        <div class="card readonly"><h3 id="cCommission">0 ‚ÇΩ</h3><p>–ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞</p></div>
        <div class="card readonly"><h3 id="cTax">0 ‚ÇΩ</h3><p>–ù–∞–ª–æ–≥</p></div>
        <div class="card readonly"><h3 id="cProfit">0 ‚ÇΩ</h3><p>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</p></div>
        <div class="card readonly"><h3 id="cEff">0%</h3><p>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p></div>
      </div>

      <div class="chart-wrap">
        <div class="chart" id="chartBars"></div>
      </div>
      <div class="hint">–î–∏–∞–≥—Ä–∞–º–º–∞: –Ω–∞–¥ —Å—Ç–æ–ª–±—Ü–æ–º ‚Äî –ø—Ä–∏–±—ã–ª—å, –ø–æ–¥ —Å—Ç–æ–ª–±—Ü–æ–º ‚Äî –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞</div>

      <div class="section">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</div>
      <div class="list">
        <div class="row"><div>–î–æ–ª—è –∞—Ä–µ–Ω–¥—ã</div><span id="rentPct" class="pill warn">0%</span></div>
        <div class="row"><div>–î–æ–ª—è —Ç–æ–ø–ª–∏–≤–∞</div><span id="fuelPct" class="pill ok">0%</span></div>
      </div>

      <footer>üöï –¢–∞–∫—Å–∏ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä v1.3 beta</footer>
    </div>

    <!-- REPORTS -->
    <div id="screen-reports" class="hidden">
      <div class="r-tabs">
        <div class="r-tab active" data-r="week">–ù–µ–¥–µ–ª—è</div>
        <div class="r-tab" data-r="month">–ú–µ—Å—è—Ü</div>
        <div class="r-tab" data-r="classes">–ö–ª–∞—Å—Å—ã</div>
      </div>

      <div class="r-range">
        <label>–ü–µ—Ä–∏–æ–¥:</label>
        <input id="fromDate" type="date">
        <span style="color:var(--muted)">‚Äî</span>
        <input id="toDate" type="date">
        <button id="rangeBtn" class="mini primary">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
      </div>

      <div id="reportsBody"></div>
      <footer>–ù–∞–∂–∏–º–∞–π –Ω–∞ –±–ª–æ–∫–∏, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏</footer>
    </div>

    <!-- SETTINGS -->
    <div id="screen-settings" class="hidden">
      <div class="section">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
      <div class="list">
        <div class="row">
          <div class="inline" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="carName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ (–Ω–∞–ø—Ä. Solaris)" style="padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0f0f10;color:#fff">
            <div class="inline" id="classButtons" style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="mini" data-cls="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</button>
              <button class="mini" data-cls="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</button>
              <button class="mini" data-cls="–ö–æ–º—Ñ–æ—Ä—Ç+">–ö–æ–º—Ñ–æ—Ä—Ç+</button>
              <button class="mini" data-cls="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</button>
            </div>
          </div>
          <button id="addCarBtn" class="mini primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="carsContainer" class="car-list" style="display:grid;gap:8px"></div>
      </div>

      <div class="section">–°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–π –ø–∞—Ä–∫–∞</div>
      <div class="list">
        <div class="row"><label class="radio"><input type="radio" name="park" value="none"> <span>–ë–µ–∑ –ø–∞—Ä–∫–∞ / –ë–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏</span></label></div>
        <div class="row"><label class="radio"><input type="radio" name="park" value="150day"> <span>150 ‚ÇΩ –∑–∞ —Ä–∞–±–æ—á–∏–µ —Å—É—Ç–∫–∏</span></label></div>
        <div class="row"><label class="radio"><input type="radio" name="park" value="15order"> <span>15 ‚ÇΩ —Å –∑–∞–∫–∞–∑–∞ (—Ä–µ–≥–∏–æ–Ω—ã)</span></label></div>
        <div class="row"><label class="radio"><input type="radio" name="park" value="20order"> <span>20 ‚ÇΩ —Å –∑–∞–∫–∞–∑–∞ (–ú–°–ö/–°–ü–±)</span></label></div>
        <div class="row"><label class="radio"><input type="radio" name="park" value="4pct"> <span>4% —Å –¥–æ—Ö–æ–¥–∞</span></label></div>
      </div>

      <div class="section">–ù–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ</div>
      <div class="list">
        <div class="row"><label class="radio"><input type="radio" name="tax" value="none"> <span>–ë–µ–∑ –Ω–∞–ª–æ–≥–∞</span></label></div>
        <div class="row"><label class="radio"><input type="radio" name="tax" value="self4"> <span>–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π 4%</span></label></div>
        <div class="row"><label class="radio"><input type="radio" name="tax" value="ip6"> <span>–ò–ü 6%</span></label></div>
      </div>

      <div class="section">–ü—Ä–æ—á–µ–µ</div>
      <div class="list">
        <div class="row">
          <div>–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</div>
          <button id="resetBtn" class="mini">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <footer>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (localStorage)</footer>
    </div>
  </div>

  <div class="nav">
    <div class="navbtn active" data-screen="home">üè† –ì–ª–∞–≤–Ω–∞—è</div>
    <div class="navbtn" data-screen="reports">üìä –û—Ç—á—ë—Ç—ã</div>
    <div class="navbtn" data-screen="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <header><b id="modalTitle">–ò–∑–º–µ–Ω–∏—Ç—å</b></header>
    <div class="body">
      <label id="modalLabel">–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
      <input id="modalInput" type="number" step="1" min="0" placeholder="0">
      <div id="quickArea" class="quick"></div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="carEditBg">
  <div class="modal">
    <header><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ</b></header>
    <div class="body">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="carEditName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Solaris">
      <label>–ö–ª–∞—Å—Å</label>
      <select id="carEditClass">
        <option>–≠–∫–æ–Ω–æ–º</option><option>–ö–æ–º—Ñ–æ—Ä—Ç</option><option>–ö–æ–º—Ñ–æ—Ä—Ç+</option><option>–ë–∏–∑–Ω–µ—Å</option>
      </select>
      <label>–û–±—ä—ë–º –±–∞–∫–∞ (–ª)</label>
      <input id="carEditTank" type="number" min="20" max="120" step="1" placeholder="50">
    </div>
    <div class="actions">
      <button class="btn ghost" id="carEditCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="carEditSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ========= –£—Ç–∏–ª–∏—Ç—ã ========= */
const fmt = (n) => (Math.round(n)).toLocaleString('ru-RU');
const rub = (n) => `${fmt(n)} ‚ÇΩ`;
const todayISO = () => { const d=new Date();return d.toISOString().slice(0,10); };
const addDays = (iso,delta)=>{const d=new Date(iso);d.setDate(d.getDate()+delta);return d.toISOString().slice(0,10);}
const rangeDays=(end,count)=>{const a=[];for(let i=count-1;i>=0;i--)a.push(addDays(end,-i));return a;}
const isoToShort = (iso)=>{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});}

/* ========= Storage schema =========
{
  activeCarId: string,
  cars: [{id,name,cls,tank}],
  settings: { parkMode:'none'|'150day'|'15order'|'20order'|'4pct', taxMode:'none'|'self4'|'ip6' },
  dataByCar: {
    [carId]: { [dateISO]: {orders,income,rent,fuel,tips,otherIncome,otherExpense,fines,hours} }
  }
}
==================================== */
const LS_KEY = 'taxiAnalyzerV13';

function loadAll() {
  const raw = localStorage.getItem(LS_KEY);
  if (raw) return JSON.parse(raw);

  // === —Å–æ–∑–¥–∞—ë–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ===
  const carId = crypto.randomUUID();
  const seedData = {};

  // === —Å–µ–Ω—Ç—è–±—Ä—å (15‚Äì30) ===
  for (let i = 15; i <= 30; i++) {
    const d = `2025-09-${String(i).padStart(2, '0')}`;
    seedData[d] = {
      orders: 18 + (i % 5),
      income: 5500 + (i % 4) * 400,
      rent: 2700,
      fuel: 1000 + (i % 3) * 100,
      tips: 100 + (i % 2) * 30,
      otherIncome: 0,
      otherExpense: (i % 6 === 0) ? 200 : 0,
      fines: 0,
      hours: 8 + (i % 3)
    };
  }

  // === –æ–∫—Ç—è–±—Ä—å (1‚Äì31) ===
  for (let i = 1; i <= 31; i++) {
    const d = `2025-10-${String(i).padStart(2, '0')}`;
    seedData[d] = {
      orders: 16 + (i % 7),
      income: 6200 + (i % 5) * 350,
      rent: 2790,
      fuel: 1100 + (i % 4) * 120,
      tips: 120 + (i % 3) * 20,
      otherIncome: (i % 10 === 0) ? 500 : 0,
      otherExpense: (i % 9 === 0) ? 300 : 0,
      fines: (i % 14 === 0) ? 500 : 0,
      hours: 9 + (i % 4)
    };
  }

  // === –Ω–æ—è–±—Ä—å (1‚Äì10) ===
  for (let i = 1; i <= 10; i++) {
    const d = `2025-11-${String(i).padStart(2, '0')}`;
    seedData[d] = {
      orders: 15 + (i % 5),
      income: 5800 + (i % 3) * 400,
      rent: 2790,
      fuel: 1300 + (i % 2) * 100,
      tips: 150 + (i % 2) * 50,
      otherIncome: (i % 5 === 0) ? 400 : 0,
      otherExpense: (i % 4 === 0) ? 200 : 0,
      fines: 0,
      hours: 8 + (i % 3)
    };
  }

  const obj = {
    activeCarId: carId,
    cars: [{ id: carId, name: 'Kia Rio', cls: '–ö–æ–º—Ñ–æ—Ä—Ç', tank: 50 }],
    settings: { parkMode: '150day', taxMode: 'none' },
    dataByCar: { [carId]: seedData }
  };

  localStorage.setItem(LS_KEY, JSON.stringify(obj));
  return obj;
}

function saveAll() {
  localStorage.setItem(LS_KEY, JSON.stringify(APP));
}

/* ========= State ========= */
let APP = loadAll();

let currentScreen='home';
let currentPeriod='day';
let currentDate=todayISO();

const byCar = () => APP.dataByCar[APP.activeCarId] || (APP.dataByCar[APP.activeCarId]={});
const ensureDay = (iso) => {
  const d = byCar()[iso];
  if (d) return d;
  return (byCar()[iso] = {orders:0,income:0,rent:0,fuel:0,tips:0,otherIncome:0,otherExpense:0,fines:0,hours:0});
}

/* ========= DOM refs ========= */
const subtitle = document.getElementById('subtitle');
const activeCarChip = document.getElementById('activeCarChip');
const dateInput = document.getElementById('dateInput');

const tabs = document.querySelectorAll('.tab');
const navbtns = document.querySelectorAll('.navbtn');
const screens = {
  home: document.getElementById('screen-home'),
  reports: document.getElementById('screen-reports'),
  settings: document.getElementById('screen-settings')
};

const sumTotal = document.getElementById('sumTotal');
const ordersLine = document.getElementById('ordersLine');
const chartBars = document.getElementById('chartBars');

const cIncome=document.getElementById('cIncome');
const cOrders=document.getElementById('cOrders');
const cRent=document.getElementById('cRent');
const cFuel=document.getElementById('cFuel');
const cTips=document.getElementById('cTips');
const cOtherIncome=document.getElementById('cOtherIncome');
const cOtherExpense=document.getElementById('cOtherExpense');
const cFines=document.getElementById('cFines');
const cHours=document.getElementById('cHours');
const cPerHour=document.getElementById('cPerHour');
const cCommission=document.getElementById('cCommission');
const cTax=document.getElementById('cTax');
const cProfit=document.getElementById('cProfit');
const cEff=document.getElementById('cEff');

const rentPctEl=document.getElementById('rentPct');
const fuelPctEl=document.getElementById('fuelPct');

const reportsBody=document.getElementById('reportsBody');

/* ========= Modal (edit values) ========= */
const modalBg = document.getElementById('modalBg');
const modalTitle=document.getElementById('modalTitle');
const modalLabel=document.getElementById('modalLabel');
const modalInput=document.getElementById('modalInput');
const quickArea=document.getElementById('quickArea');
const btnCancel=document.getElementById('btnCancel');
const btnSave=document.getElementById('btnSave');
let editField=null;

const QUICK_PRESETS = {
  income: [1000,3000,5000],
  otherIncome: [500,1000,2000],
  tips: [50,100,200],
  rent: [500,1000,1500],
  fuel: [100,500,1000],
  otherExpense: [100,300,500],
  fines: [500,1000,3000],
  orders: [1,5,10],
  hours: [1,2,4]
};

function renderQuick(field){
  quickArea.innerHTML = '';
  (QUICK_PRESETS[field]||[]).forEach(val=>{
    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent = field==='orders'||field==='hours' ? `+${val}` : `+${val} ‚ÇΩ`;
    chip.onclick=()=>{ modalInput.value = Number(modalInput.value||0) + val; };
    quickArea.appendChild(chip);
  });
}
function openModal(field,title){
  editField=field; modalTitle.textContent=title; modalLabel.textContent='–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ';
  modalInput.value = Number(ensureDay(currentDate)[field]||0);
  renderQuick(field);
  modalBg.classList.add('show'); modalInput.focus();
}
function closeModal(){ modalBg.classList.remove('show'); editField=null; }
btnCancel.onclick=closeModal;
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) closeModal(); });
btnSave.onclick=()=>{
  if(!editField) return;
  const v = Number(modalInput.value||0);
  ensureDay(currentDate)[editField]=v;
  saveAll(); closeModal(); render();
};

/* ========= Car Edit Modal ========= */
const carEditBg=document.getElementById('carEditBg');
const carEditName=document.getElementById('carEditName');
const carEditClass=document.getElementById('carEditClass');
const carEditTank=document.getElementById('carEditTank');
const carEditCancel=document.getElementById('carEditCancel');
const carEditSave=document.getElementById('carEditSave');
let editingCarId=null;

function openCarEdit(car){
  editingCarId=car.id;
  carEditName.value=car.name||'';
  carEditClass.value=car.cls||'–≠–∫–æ–Ω–æ–º';
  carEditTank.value=car.tank||50;
  carEditBg.classList.add('show');
}
function closeCarEdit(){ carEditBg.classList.remove('show'); editingCarId=null; }
carEditCancel.onclick=closeCarEdit;
carEditBg.addEventListener('click',e=>{ if(e.target===carEditBg) closeCarEdit(); });
carEditSave.onclick=()=>{
  const car=APP.cars.find(x=>x.id===editingCarId);
  if(!car) return;
  car.name=carEditName.value||car.name;
  car.cls=carEditClass.value||car.cls;
  car.tank=Number(carEditTank.value||car.tank||50);
  saveAll(); closeCarEdit(); render();
};

/* ========= Cars UI ========= */
const carName=document.getElementById('carName');
const classButtons=document.getElementById('classButtons');
let newCarClass='–≠–∫–æ–Ω–æ–º';
classButtons.querySelectorAll('button').forEach(b=>{
  b.onclick=()=>{ newCarClass=b.dataset.cls; classButtons.querySelectorAll('button').forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); };
});
const addCarBtn=document.getElementById('addCarBtn');
const carsContainer=document.getElementById('carsContainer');

function renderCars(){
  const items = APP.cars.map(c=>`
    <div class="car-item" style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:12px">
      <div><b>${c.name}</b> ¬∑ <span style="color:var(--muted)">${c.cls||'-'}</span> ¬∑ –±–∞–∫ ${c.tank||'-'} –ª</div>
      <div class="car-actions" style="display:flex;gap:8px">
        <button class="mini" data-edit="${c.id}">‚öôÔ∏è</button>
        <button class="mini ${APP.activeCarId===c.id?'primary':''}" data-car="${c.id}">${APP.activeCarId===c.id?'–ê–∫—Ç–∏–≤–Ω–æ':'–í—ã–±—Ä–∞—Ç—å'}</button>
        <button class="mini" data-del="${c.id}">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  `).join('');
  carsContainer.innerHTML = items || '<div class="row">–ù–µ—Ç –º–∞—à–∏–Ω ‚Äî –¥–æ–±–∞–≤—å –≤—ã—à–µ</div>';

  carsContainer.querySelectorAll('button[data-car]').forEach(b=>{
    b.onclick=()=>{ APP.activeCarId=b.dataset.car; saveAll(); render(); };
  });
  carsContainer.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.del;
      if(APP.cars.length===1){ alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –º–∞—à–∏–Ω—É'); return; }
      APP.cars=APP.cars.filter(x=>x.id!==id);
      delete APP.dataByCar[id];
      if(APP.activeCarId===id) APP.activeCarId=APP.cars[0].id;
      saveAll(); render();
    };
  });
  carsContainer.querySelectorAll('button[data-edit]').forEach(b=>{
    b.onclick=()=>{ const car=APP.cars.find(x=>x.id===b.dataset.edit); if(car) openCarEdit(car); };
  });
}
addCarBtn.onclick=()=>{
  const name=(carName.value||'').trim();
  if(!name) return alert('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ');
  const id=crypto.randomUUID();
  APP.cars.push({id,name,cls:newCarClass,tank:50});
  APP.dataByCar[id]={};
  APP.activeCarId=id;
  carName.value=''; newCarClass='–≠–∫–æ–Ω–æ–º';
  classButtons.querySelectorAll('button').forEach(x=>x.classList.remove('primary'));
  saveAll(); render();
};

/* ========= Settings (commission & tax) ========= */
function bindSettingsRadios(){
  document.querySelectorAll('input[name="park"]').forEach(r=>{
    r.checked = (APP.settings.parkMode===r.value);
    r.onchange = ()=>{ APP.settings.parkMode=r.value; saveAll(); render(); };
  });
  document.querySelectorAll('input[name="tax"]').forEach(r=>{
    r.checked = (APP.settings.taxMode===r.value);
    r.onchange = ()=>{ APP.settings.taxMode=r.value; saveAll(); render(); };
  });
  document.getElementById('resetBtn').onclick = () => {
    if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–ø—Ä–∏–º–µ—Ä?')) {
      localStorage.removeItem(LS_KEY);
      setTimeout(() => {
        APP = loadAll();
        saveAll();
        currentDate = "2025-11-10"; // –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –∏–∑ –¥–µ–º–æ
        currentPeriod = "day";
        render();
        alert('‚úÖ –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –û—Ç–∫—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–Ω—Ç—è–±—Ä—å, –æ–∫—Ç—è–±—Ä—å –∏ –Ω–æ—è–±—Ä—å!');
      }, 150);
    }
  };
}

/* ========= Calculations ========= */
function calcCommission(d){
  const mode = APP.settings.parkMode || 'none';
  if(mode==='none') return 0;
  if(mode==='150day'){
    return ( (d.income||0) > 0 || (d.orders||0) > 0 ) ? 150 : 0;
  }
  if(mode==='15order'){ return (d.orders||0) * 15; }
  if(mode==='20order'){ return (d.orders||0) * 20; }
  if(mode==='4pct'){ return (d.income||0) * 0.04; }
  return 0;
}
function calcTax(d){
  const mode = APP.settings.taxMode || 'none';
  if(mode==='self4') return (d.income||0) * 0.04;
  if(mode==='ip6')   return (d.income||0) * 0.06;
  return 0;
}
function calcDay(iso){
  const d = ensureDay(iso);
  const gross = (d.income||0) + (d.tips||0) + (d.otherIncome||0);
  const commission = calcCommission(d);
  const tax = calcTax(d);
  const costs = (d.rent||0)+(d.fuel||0)+(d.otherExpense||0)+(d.fines||0)+commission+tax;
  const profit = gross - costs;
  const eff = gross>0 ? Math.max(0, Math.round((profit/gross)*100)) : 0;
  const perHour = (d.hours||0)>0 ? profit / d.hours : 0;
  return {...d, commission, tax, gross, costs, profit, eff, perHour};
}
function sumRange(arr){
  return arr.reduce((acc,iso)=>{
    const d = ensureDay(iso);
    const c = calcCommission(d);
    const t = calcTax(d);
    acc.orders += Number(d.orders||0);
    acc.income += Number(d.income||0);
    acc.rent   += Number(d.rent||0);
    acc.fuel   += Number(d.fuel||0);
    acc.tips   += Number(d.tips||0);
    acc.otherIncome  += Number(d.otherIncome||0);
    acc.otherExpense += Number(d.otherExpense||0);
    acc.fines  += Number(d.fines||0);
    acc.hours  += Number(d.hours||0);
    acc.commission += c;
    acc.tax += t;
    return acc;
  }, {orders:0,income:0,rent:0,fuel:0,tips:0,otherIncome:0,otherExpense:0,fines:0,hours:0,commission:0,tax:0});
}

/* ========= Timeline chart ========= */
function renderTimeline(values, labels, dates){
  chartBars.innerHTML='';
  const max=Math.max(1,...values.map(v=>Math.max(0,v)));
  values.forEach((v,i)=>{
    const col=document.createElement('div');
    col.className='barcol';
    const top=document.createElement('div'); 
    top.className='bar-top'; 
    top.textContent = v>0 ? rub(v) : '0 ‚ÇΩ';

    const bar=document.createElement('div'); 
    bar.className='bar'; 
    bar.style.height = `${(Math.max(0,v)/max)*170}px`;
    bar.style.cursor = 'pointer';

    bar.onclick = () => {
      if (currentPeriod === 'day') {
        currentDate = dates[i];
        currentPeriod = 'day';
        tabs.forEach(x => x.classList.remove('active'));
        document.querySelector('.tab[data-period="day"]').classList.add('active');
        dateInput.value = currentDate;
        render();
      } 
      else if (currentPeriod === 'week') {
        const endISO = dates[i];
        const range = rangeDays(endISO, 7);
        const summary = sumRange(range);
        showReportModal('–ù–µ–¥–µ–ª—è', range[0], range[6], summary);
      } 
      else if (currentPeriod === 'month') {
        const endISO = dates[i];
        const range = rangeDays(endISO, 30);
        const summary = sumRange(range);
        showReportModal('–ú–µ—Å—è—Ü', range[0], range[range.length-1], summary);
      }
    };

    const bottom=document.createElement('div'); 
    bottom.className='bar-bottom'; 
    bottom.textContent = labels[i];

    col.appendChild(top); 
    col.appendChild(bar); 
    col.appendChild(bottom);
    chartBars.appendChild(col);
  });
}
function showReportModal(title, fromISO, toISO, s){
  const gross = s.income + s.tips + s.otherIncome;
  const profit = gross - (s.rent + s.fuel + s.otherExpense + s.fines + s.commission + s.tax);
  const eff = gross>0 ? Math.round((profit/gross)*100) : 0;
  const perHour = (s.hours||0)>0 ? profit / s.hours : 0;

  currentScreen = 'reports';
  rMode = 'custom';
  render();

  const headerLine = `üìÜ ${title} ${isoToShort(fromISO)} ‚Äì ${isoToShort(toISO)} ¬∑ ${fmt(s.orders)} –∑–∞–∫–∞–∑–æ–≤ ¬∑ ${rub(gross)} –¥–æ—Ö–æ–¥–∞`;

  reportsBody.innerHTML = `
    <div style="margin-bottom:10px;font-size:13px;color:var(--muted);text-align:center;">${headerLine}</div>
    <details class="collapse" open>
      <summary><b>–°–≤–æ–¥–∫–∞</b></summary>
      <div class="body">
        <div class="row"><div>–î–æ—Ö–æ–¥</div><b>${rub(gross)}</b></div>
        <div class="row"><div>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div><b>${rub(profit)}</b></div>
        <div class="row"><div>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><b>${eff}%</b></div>
        <div class="row"><div>–ß–∞—Å—ã –≤—Å–µ–≥–æ</div><b>${fmt(s.hours||0)} —á</b></div>
        <div class="row"><div>‚ÇΩ/—á–∞—Å</div><b>${fmt(Math.round(perHour))} ‚ÇΩ/—á</b></div>
      </div>
    </details>
    <details class="collapse">
      <summary>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</summary>
      <div class="body">
        <div class="row"><div>–ê—Ä–µ–Ω–¥–∞</div><b>${rub(s.rent)}</b></div>
        <div class="row"><div>–¢–æ–ø–ª–∏–≤–æ</div><b>${rub(s.fuel)}</b></div>
        <div class="row"><div>–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div><b>${rub(s.otherExpense)}</b></div>
        <div class="row"><div>–®—Ç—Ä–∞—Ñ—ã</div><b>${rub(s.fines)}</b></div>
        <div class="row"><div>–ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞</div><b>${rub(s.commission)}</b></div>
        <div class="row"><div>–ù–∞–ª–æ–≥</div><b>${rub(s.tax)}</b></div>
      </div>
    </details>
  `;

  subtitle.textContent = `${title} ¬∑ –æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥`;
}

/* ===== Reports ===== */
const rTabs=document.querySelectorAll('.r-tab');
let rMode='week';

function buildSummaryCard(title, s){
  const gross = s.income + s.tips + s.otherIncome;
  const profit = gross - (s.rent+s.fuel+s.otherExpense+s.fines+s.commission+s.tax);
  const eff = gross>0 ? Math.max(0, Math.round((profit/gross)*100)) : 0;
  const perHour = (s.hours||0)>0 ? profit / s.hours : 0;
  return `
    <details class="collapse" open>
      <summary><b>${title}</b></summary>
      <div class="body">
        <div class="row"><div>–î–æ—Ö–æ–¥</div><b>${rub(gross)}</b></div>
        <div class="row"><div>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div><b>${rub(profit)}</b></div>
        <div class="row"><div>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><b>${eff}%</b></div>
        <div class="row"><div>–ß–∞—Å—ã –≤—Å–µ–≥–æ</div><b>${fmt(s.hours||0)} —á</b></div>
        <div class="row"><div>‚ÇΩ/—á–∞—Å</div><b>${fmt(Math.round(perHour))} ‚ÇΩ/—á</b></div>
      </div>
    </details>
    <details class="collapse">
      <summary>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</summary>
      <div class="body">
        <div class="row"><div>–ê—Ä–µ–Ω–¥–∞</div><b>${rub(s.rent)}</b></div>
        <div class="row"><div>–¢–æ–ø–ª–∏–≤–æ</div><b>${rub(s.fuel)}</b></div>
        <div class="row"><div>–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div><b>${rub(s.otherExpense)}</b></div>
        <div class="row"><div>–®—Ç—Ä–∞—Ñ—ã</div><b>${rub(s.fines)}</b></div>
        <div class="row"><div>–ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞</div><b>${rub(s.commission)}</b></div>
        <div class="row"><div>–ù–∞–ª–æ–≥</div><b>${rub(s.tax)}</b></div>
      </div>
    </details>
  `;
}

function renderReports(){
  reportsBody.innerHTML='';
  if(rMode==='classes'){
    const map = {};
    for(const car of APP.cars){
      const data = APP.dataByCar[car.id]||{};
      let sum = {orders:0,income:0,rent:0,fuel:0,tips:0,otherIncome:0,otherExpense:0,fines:0,hours:0,commission:0,tax:0};
      Object.keys(data).forEach(iso=>{
        const d=data[iso];
        const c = calcCommission(d);
        const t = calcTax(d);
        sum.orders+=d.orders||0; sum.income+=d.income||0; sum.rent+=d.rent||0; sum.fuel+=d.fuel||0;
        sum.tips+=d.tips||0; sum.otherIncome+=d.otherIncome||0; sum.otherExpense+=d.otherExpense||0; sum.fines+=d.fines||0;
        sum.hours+=d.hours||0; sum.commission+=c; sum.tax+=t;
      });
      const key=car.cls||'‚Äî';
      if(!map[key]) map[key]={title:key, sum:{...sum}};
      else Object.keys(sum).forEach(k=>map[key].sum[k]+=sum[k]);
    }
    const parts = Object.values(map)
      .filter(x=>{
        const total = x.sum.income + x.sum.tips + x.sum.otherIncome + x.sum.rent + x.sum.fuel + x.sum.otherExpense + x.sum.fines;
        return total>0;
      })
      .map(x=>buildSummaryCard(`–ö–ª–∞—Å—Å: ${x.title}`, x.sum));
    reportsBody.innerHTML = parts.length? parts.join('') : '<div class="row">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤</div>';
    return;
  }

  const days = rMode==='week'?7:30;
  const arr = rangeDays(todayISO(), days);
  const s = sumRange(arr);

  reportsBody.innerHTML = buildSummaryCard(rMode==='week'?'–ù–µ–¥–µ–ª—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)':'–ú–µ—Å—è—Ü (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)', s);
}

/* ========= Render hub ========= */
function render(){
  Object.values(screens).forEach(s=>s.classList.add('hidden'));
  screens[currentScreen].classList.remove('hidden');
  navbtns.forEach(b=>b.classList.remove('active'));
  document.querySelector(`.navbtn[data-screen="${currentScreen}"]`).classList.add('active');

  dateInput.value = currentDate;

  if(currentScreen==='settings'){ renderCars(); bindSettingsRadios(); }
  if(currentScreen==='home') renderHome();
  if(currentScreen==='reports') renderReports();
}

/* ========= Home render ========= */
function renderHome(){
  const car = APP.cars.find(c=>c.id===APP.activeCarId);
  activeCarChip.textContent = '–ê–≤—Ç–æ: ' + (car ? `${car.name} ¬∑ ${car.cls}` : '‚Äî');

  const d = new Date(currentDate);
  subtitle.textContent = (currentPeriod==='day')
    ? `–ì–ª–∞–≤–Ω–∞—è ¬∑ ${d.toLocaleDateString('ru-RU')}`
    : (currentPeriod==='week' ? '–ì–ª–∞–≤–Ω–∞—è ¬∑ –Ω–µ–¥–µ–ª–∏' : '–ì–ª–∞–≤–Ω–∞—è ¬∑ –º–µ—Å—è—Ü—ã');

  if(currentPeriod==='day'){
    const x = calcDay(currentDate);
    sumTotal.textContent = rub(x.gross);
    ordersLine.textContent = `${fmt(x.orders)} –∑–∞–∫–∞–∑–æ–≤`;

    cIncome.textContent=rub(x.income);
    cTips.textContent=rub(x.tips);
    cOtherIncome.textContent=rub(x.otherIncome);
    cOrders.textContent=fmt(x.orders);

    cRent.textContent=rub(x.rent);
    cFuel.textContent=rub(x.fuel);
    cOtherExpense.textContent=rub(x.otherExpense);
    cFines.textContent=rub(x.fines);

    cHours.textContent = `${fmt(x.hours||0)} —á`;
    cPerHour.textContent = `${fmt(Math.round(x.perHour))} ‚ÇΩ/—á`;

    cCommission.textContent=rub(x.commission);
    cTax.textContent=rub(x.tax);
    cProfit.textContent=rub(x.profit);
    cEff.textContent=`${x.eff}%`;

    const rPct = x.gross>0 ? Math.round((x.rent/x.gross)*100) : 0;
    const fPct = x.gross>0 ? Math.round((x.fuel/x.gross)*100) : 0;
    rentPctEl.textContent=rPct+'%'; fuelPctEl.textContent=fPct+'%';
    rentPctEl.className='pill ' + (rPct>35?'bad':(rPct>25?'warn':'ok'));
    fuelPctEl.className='pill ' + (fPct>30?'bad':(fPct>20?'warn':'ok'));

    const daysAround = 3;
    const arr = [];
    for(let i = -daysAround; i <= daysAround; i++) arr.push(addDays(currentDate, i));
    const vals = arr.map(iso => { const d = calcDay(iso); return Math.max(0, d.profit); });
    const labels = arr.map(iso => isoToShort(iso));
    renderTimeline(vals, labels, arr);
    setTimeout(() => {
      const bars = chartBars.querySelectorAll('.bar');
      arr.forEach((iso, i) => {
        if (iso === currentDate) bars[i].style.outline = '2px solid var(--accent)';
      });
    }, 50);

    return;
  }

  // –ù–ï–î–ï–õ–Ø
  if (currentPeriod === 'week') {
    const weeks = 8;
    const arr = [];
    const today = new Date();

    const currentMonday = new Date(today);
    const day = currentMonday.getDay() || 7;
    if (day !== 1) currentMonday.setDate(currentMonday.getDate() - (day - 1));

    for (let i = weeks - 1; i >= 0; i--) {
      const start = new Date(currentMonday);
      start.setDate(currentMonday.getDate() - i * 7);

      const end = new Date(start);
      end.setDate(start.getDate() + 6);

      const startISO = start.toLocaleDateString('en-CA');
      const endISO = end.toLocaleDateString('en-CA');

      const range = [];
      let cur = new Date(start);
      while (cur <= end) {
        range.push(cur.toLocaleDateString('en-CA'));
        cur.setDate(cur.getDate() + 1);
      }

      const sum = sumRange(range);
      const gross = sum.income + sum.tips + sum.otherIncome;
      const profit = gross - (sum.rent + sum.fuel + sum.otherExpense + sum.fines + sum.commission + sum.tax);

      arr.push({
        label: `${start.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'})}‚Äì${end.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'})}`,
        startISO,
        endISO,
        profit,
      });
    }

    const vals = arr.map((w) => Math.max(0, w.profit));
    const labels = arr.map((w) => w.label);
    const dates = arr.map((w) => w.endISO);
    renderTimeline(vals, labels, dates);

    // –°–≤–æ–¥–∫–∞ –∑–∞ —Ç–µ–∫—É—â—É—é –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é –Ω–µ–¥–µ–ª—é
    const endThisWeek = new Date(currentMonday);
    endThisWeek.setDate(currentMonday.getDate() + 6);

    const rangeThisWeek = [];
    let cur = new Date(currentMonday);
    while (cur <= endThisWeek) {
      rangeThisWeek.push(cur.toLocaleDateString('en-CA'));
      cur.setDate(cur.getDate() + 1);
    }

    const s = sumRange(rangeThisWeek);
    const gross = s.income + s.tips + s.otherIncome;
    const profit = gross - (s.rent + s.fuel + s.otherExpense + s.fines + s.commission + s.tax);
    const eff = gross > 0 ? Math.round((profit / gross) * 100) : 0;
    const perHour = (s.hours || 0) > 0 ? profit / s.hours : 0;

    sumTotal.textContent = rub(gross);
    ordersLine.textContent = `${fmt(s.orders)} –∑–∞–∫–∞–∑–æ–≤`;
    cIncome.textContent = rub(s.income);
    cTips.textContent = rub(s.tips);
    cOtherIncome.textContent = rub(s.otherIncome);
    cOrders.textContent = fmt(s.orders);
    cRent.textContent = rub(s.rent);
    cFuel.textContent = rub(s.fuel);
    cOtherExpense.textContent = rub(s.otherExpense);
    cFines.textContent = rub(s.fines);
    cCommission.textContent = rub(s.commission);
    cTax.textContent = rub(s.tax);
    cProfit.textContent = rub(profit);
    cEff.textContent = `${eff}%`;
    cHours.textContent = `${fmt(s.hours || 0)} —á`;
    cPerHour.textContent = `${fmt(Math.round(perHour))} ‚ÇΩ/—á`;
  }

  // –ú–ï–°–Ø–¶
  if(currentPeriod==='month'){
    const months = 6;
    const arr = [];
    const now = new Date();

    for(let i = months - 1; i >= 0; i--){
      const year = now.getFullYear();
      const month = now.getMonth() - i;
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0);
      const startISO = start.toLocaleDateString('en-CA');
      const endISO = end.toLocaleDateString('en-CA');

      const range = [];
      let cur = new Date(start);
      while(cur <= end){
        range.push(cur.toLocaleDateString('en-CA'));
        cur.setDate(cur.getDate() + 1);
      }

      const sum = sumRange(range);
      const gross = sum.income + sum.tips + sum.otherIncome;
      const profit = gross - (sum.rent + sum.fuel + sum.otherExpense + sum.fines + sum.commission + sum.tax);

      arr.push({ label: start.toLocaleString('ru-RU',{month:'short'}), startISO, endISO, profit });
    }

    const vals = arr.map(m => Math.max(0, m.profit));
    const labels = arr.map(m => m.label);
    const dates = arr.map(m => m.endISO);
    renderTimeline(vals, labels, dates);

    const startThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const endThisMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    const rangeThisMonth = [];
    let cur = new Date(startThisMonth);
    while(cur <= endThisMonth){
      rangeThisMonth.push(cur.toLocaleDateString('en-CA'));
      cur.setDate(cur.getDate() + 1);
    }

    const s = sumRange(rangeThisMonth);
    const gross = s.income + s.tips + s.otherIncome;
    const profit = gross - (s.rent + s.fuel + s.otherExpense + s.fines + s.commission + s.tax);
    const eff = gross>0 ? Math.round((profit/gross)*100) : 0;
    const perHour = (s.hours||0)>0 ? profit / s.hours : 0;

    sumTotal.textContent=rub(gross);
    ordersLine.textContent=`${fmt(s.orders)} –∑–∞–∫–∞–∑–æ–≤`;
    cIncome.textContent=rub(s.income);
    cTips.textContent=rub(s.tips);
    cOtherIncome.textContent=rub(s.otherIncome);
    cOrders.textContent=fmt(s.orders);
    cRent.textContent=rub(s.rent);
    cFuel.textContent=rub(s.fuel);
    cOtherExpense.textContent=rub(s.otherExpense);
    cFines.textContent=rub(s.fines);
    cCommission.textContent=rub(s.commission);
    cTax.textContent=rub(s.tax);
    cProfit.textContent=rub(profit);
    cEff.textContent=`${eff}%`;
    cHours.textContent=`${fmt(s.hours||0)} —á`;
    cPerHour.textContent=`${fmt(Math.round(perHour))} ‚ÇΩ/—á`;
  }
}

/* ========= Events ========= */
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  currentPeriod=t.dataset.period;
  render();
}));

navbtns.forEach(n=>n.addEventListener('click',()=>{
  currentScreen=n.dataset.screen;
  render();
}));

dateInput.addEventListener('change', (e)=>{
  currentDate = e.target.value || todayISO();
  ensureDay(currentDate);
  saveAll();
  tabs.forEach(x=>x.classList.remove('active'));
  document.querySelector('.tab[data-period="day"]').classList.add('active');
  currentPeriod='day';
  render();
}));

document.querySelectorAll('.card[data-edit]').forEach(c=>{
  c.addEventListener('click', ()=>{
    if(currentPeriod!=='day'){
      tabs.forEach(x=>x.classList.remove('active'));
      document.querySelector('.tab[data-period="day"]').classList.add('active');
      currentPeriod='day';
    }
    const field=c.dataset.edit;
    const titles={
      income:'–î–æ—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å', tips:'–ß–∞–µ–≤—ã–µ –∑–∞ –¥–µ–Ω—å', otherIncome:'–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å',
      orders:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤', rent:'–ê—Ä–µ–Ω–¥–∞ –∑–∞ –¥–µ–Ω—å', fuel:'–¢–æ–ø–ª–∏–≤–æ –∑–∞ –¥–µ–Ω—å',
      otherExpense:'–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å', fines:'–®—Ç—Ä–∞—Ñ—ã –∑–∞ –¥–µ–Ω—å', hours:'–ß–∞—Å—ã –∑–∞ –¥–µ–Ω—å'
    };
    openModal(field, titles[field]||'–ò–∑–º–µ–Ω–∏—Ç—å');
  });
});

rTabs.forEach(rt=>rt.addEventListener('click',()=>{
  rTabs.forEach(x=>x.classList.remove('active'));
  rt.classList.add('active');
  rMode=rt.dataset.r;
  render();
}));

/* ===== –û—Ç—á—ë—Ç –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É ===== */
const rangeBtn = document.getElementById('rangeBtn');
const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');
rangeBtn.onclick = () => {
  const from = fromDate.value, to = toDate.value;
  if (!from || !to) { alert('–£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã'); return; }
  if (from > to) { alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è'); return; }

  const arr = [];
  let cur = new Date(from);
  const end = new Date(to);
  while (cur <= end) {
    arr.push(cur.toLocaleDateString('en-CA'));
    cur.setDate(cur.getDate() + 1);
  }

  const s = sumRange(arr);
  const gross = s.income + s.tips + s.otherIncome;
  const profit = gross - (s.rent + s.fuel + s.otherExpense + s.fines + s.commission + s.tax);

  reportsBody.innerHTML = `
    <div style="margin-bottom:10px;font-size:13px;color:var(--muted);text-align:center;">
      üìÖ –ü–µ—Ä–∏–æ–¥: ${isoToShort(from)} ‚Äî ${isoToShort(to)}
    </div>
    ${buildSummaryCard('–û—Ç—á—ë—Ç –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É', s)}
  `;
};

/* ========= First render ========= */
render();

/* ==== Telegram Mini App integration ==== */
(function initTelegram() {
  try {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      Telegram.WebApp.setHeaderColor("secondary_bg_color");
      if (Telegram.WebApp.disableVerticalSwipes) {
        Telegram.WebApp.disableVerticalSwipes();
      }
      console.log("[TaxiPro] Telegram WebApp initialized ‚úÖ");
    } else {
      console.warn("[TaxiPro] Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚ö†Ô∏è");
    }
  } catch (e) {
    console.error("[TaxiPro] Telegram init error:", e);
  }
})();

/* ==== –î–æ–ø. —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç ¬´–ø—Ä—É–∂–∏–Ω—ã¬ª –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –Ω–∞ iOS/Telegram ==== */
(function preventOverscrollBounce(){
  let startY=0;
  document.addEventListener('touchstart',e=>{
    startY=e.touches[0].clientY;
  },{passive:false});
  document.addEventListener('touchmove',e=>{
    const content = document.querySelector('.content');
    if(!content) return;
    const atTop = content.scrollTop <= 0;
    const atBottom = Math.ceil(content.scrollTop + content.clientHeight) >= content.scrollHeight;
    const deltaY = e.touches[0].clientY - startY;
    if ((atTop && deltaY > 0) || (atBottom && deltaY < 0)) {
      e.preventDefault();
    }
  },{passive:false});
})();
</script>
</body>
</html>
